# Complete Pipeline Output Structure

## Overview

This document describes all output files generated by the integration site analysis pipeline, organized by process.

---

## ðŸ“ Full Directory Tree

```
results/
â”œâ”€â”€ hifiasm/
â”‚   â”œâ”€â”€ MySample.asm.bp.p_ctg.gfa           # Primary assembly graph (GFA format)
â”‚   â””â”€â”€ versions.yml                         # Hifiasm version info
â”‚
â”œâ”€â”€ purge_dups/
â”‚   â”œâ”€â”€ MySample_purged.fa                   # Final purged assembly (primary output)
â”‚   â”œâ”€â”€ MySample_haplotigs.fa                # Removed haplotigs
â”‚   â”œâ”€â”€ MySample_dups.bed                    # Coordinates of duplicated regions
â”‚   â”œâ”€â”€ PB.base.cov                          # Per-base coverage from initial alignment
â”‚   â”œâ”€â”€ cutoffs                              # Auto-calculated coverage cutoffs
â”‚   â”œâ”€â”€ MySample_summary.txt                 # Statistics summary
â”‚   â””â”€â”€ versions.yml                         # Tool versions
â”‚
â”œâ”€â”€ minimap2_align/
â”‚   â”œâ”€â”€ MySample.paf                         # Assembly-to-reference alignment
â”‚   â””â”€â”€ versions.yml                         # Minimap2 version info
â”‚
â””â”€â”€ qc_plots/
    â”œâ”€â”€ MySample_alignment_lengths.png       # Histogram of alignment lengths
    â”œâ”€â”€ MySample_mapping_quality.png         # Histogram of mapping quality scores
    â”œâ”€â”€ MySample_sites_per_chr.png           # Bar chart of integration sites
    â””â”€â”€ versions.yml                         # Python/matplotlib versions
```

---

## ðŸ“Š Output File Details

### 1. HIFIASM Output (`results/hifiasm/`)

#### `MySample.asm.bp.p_ctg.gfa`
- **Format**: GFA (Graphical Fragment Assembly)
- **Description**: Primary contig assembly graph
- **Size**: Typically 10-500 MB (depending on genome size)
- **Contains**:
  - Segment records (S): Assembled contig sequences
  - Link records (L): Connections between segments
  - Path records (P): Paths through the graph
- **Usage**: Input for purge_dups and can be visualized with Bandage

**Example GFA snippet:**
```
H       VN:Z:1.0
S       ptg000001l      ACGTACGTACGT...     LN:i:1245678
S       ptg000002l      TGCATGCATGCA...     LN:i:987654
L       ptg000001l      +       ptg000002l      +       100M
```

#### `versions.yml`
```yaml
"HIFIASM":
    hifiasm: 0.19.8
```

---

### 2. PURGE_DUPS Output (`results/purge_dups/`)

#### `MySample_purged.fa` â­ **PRIMARY OUTPUT**
- **Format**: FASTA
- **Description**: Final purged assembly with haplotigs removed
- **Size**: Typically 50-90% of input assembly size
- **Contains**: High-confidence primary contigs
- **Quality**: One haplotype representation with duplicates removed

**Example:**
```
>ptg000001l_purged
ATCGATCGATCGATCGATCG...
>ptg000003l_purged
GCTAGCTAGCTAGCTAGCTA...
```

#### `MySample_haplotigs.fa`
- **Format**: FASTA
- **Description**: Removed haplotigs and duplicated sequences
- **Size**: Typically 10-50% of input assembly size
- **Contains**: Alternative haplotype contigs and false duplications
- **Usage**: Can be analyzed separately or discarded

**Example:**
```
>ptg000002l_haplotig
ATCGATCGATCGATCGATCG...
>ptg000005l_haplotig
GCTAGCTAGCTAGCTAGCTA...
```

#### `MySample_dups.bed`
- **Format**: BED (Browser Extensible Data)
- **Description**: Coordinates of duplicated/haplotig regions
- **Columns**:
  1. Contig name
  2. Start position (0-based)
  3. End position
  4. Type (HAPLOTIG, OVLP, REPEAT, JUNK, HIGHCOV)
  5. Score/coverage

**Example:**
```
ptg000002l      0       987654  HAPLOTIG        85
ptg000005l      0       654321  HAPLOTIG        78
ptg000007l      100000  150000  REPEAT          120
```

#### `PB.base.cov`
- **Format**: Custom text format
- **Description**: Per-base coverage statistics from HiFi read alignment
- **Columns**: Contig, Position, Coverage
- **Size**: Can be very large (100s of MB for large genomes)
- **Usage**: Used internally by calcuts to determine coverage thresholds

**Example:**
```
ptg000001l      1       45
ptg000001l      2       47
ptg000001l      3       46
...
```

#### `cutoffs`
- **Format**: Plain text
- **Description**: Auto-calculated coverage cutoffs for duplicate detection
- **Contains**:
  - Low coverage cutoff (junk threshold)
  - High coverage cutoff (repeat threshold)
  - Transition midpoint

**Example:**
```
10      # Low cutoff (discard if coverage < 10)
80      # High cutoff (consider repeat if coverage > 80)
45      # Midpoint
```

#### `MySample_summary.txt`
- **Format**: Plain text
- **Description**: Summary statistics of purging process
- **Contains**:
  - Number of input contigs
  - Number of purged contigs retained
  - Number of haplotigs identified
  - Total bases in purged assembly
  - Total bases in haplotigs
  - Purging percentage

**Example:**
```
=== Purge_dups Summary ===
Input contigs:          245
Purged contigs:         128
Haplotigs removed:      117
Purged assembly size:   2.8 Gb
Haplotigs size:         1.2 Gb
Percentage purged:      43%
```

#### `versions.yml`
```yaml
"PURGE_DUPS":
    minimap2: 2.26
    purge_dups: 1.2.6
```

---

### 3. MINIMAP2_ALIGN Output (`results/minimap2_align/`)

#### `MySample.paf`
- **Format**: PAF (Pairwise mApping Format)
- **Description**: Alignment of purged assembly to reference genome
- **Size**: 1-100 MB depending on assembly and reference sizes
- **Columns** (12 mandatory + optional tags):
  1. Query sequence name (contig from assembly)
  2. Query sequence length
  3. Query start (0-based)
  4. Query end
  5. Strand (+ or -)
  6. Target sequence name (chromosome from reference)
  7. Target sequence length
  8. Target start (0-based)
  9. Target end
  10. Number of matching bases
  11. Alignment block length
  12. Mapping quality (0-255)

**Example:**
```
ptg000001l_purged  1245678  0  1245000  +  chr1  248956422  1000000  2245000  1200000  1245000  60
ptg000003l_purged  987654   0  987000   +  chr2  242193529  5000000  5987000  950000   987000   60
ptg000005l_purged  654321   0  654000   -  chr3  198295559  10000000 10654000 640000   654000   55
```

**Key Metrics**:
- **Mapping quality**: 60 = unique alignment, <60 = ambiguous
- **Strand**: + = same orientation, - = reverse complement
- **Coverage**: (Query end - Query start) / Query length

#### `versions.yml`
```yaml
"MINIMAP2_ALIGN":
    minimap2: 2.26
```

---

### 4. QC_PLOTS Output (`results/qc_plots/`)

#### `MySample_alignment_lengths.png` ðŸ“Š
- **Format**: PNG image (300 DPI)
- **Dimensions**: 10" Ã— 6"
- **Description**: Histogram showing distribution of alignment lengths
- **X-axis**: Alignment length (bp)
- **Y-axis**: Frequency (count)
- **Purpose**: Assess assembly contiguity and alignment quality

**Interpretation**:
- **Peak at high values**: Good contiguity, long contigs align well
- **Peak at low values**: Fragmented assembly or poor alignment
- **Bimodal distribution**: May indicate two populations (e.g., different chromosome types)

**Visual Example:**
```
Frequency
    |     
100 |         â•­â”€â•®
 80 |       â•­â”€â•¯ â•°â”€â•®
 60 |     â•­â”€â•¯     â•°â”€â•®
 40 |   â•­â”€â•¯         â•°â”€â•®
 20 | â•­â”€â•¯             â•°â”€â•®
  0 |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Alignment Length (bp)
      0   500k  1M  1.5M  2M
```

#### `MySample_mapping_quality.png` ðŸ“Š
- **Format**: PNG image (300 DPI)
- **Dimensions**: 10" Ã— 6"
- **Description**: Histogram showing distribution of mapping quality scores
- **X-axis**: Mapping quality (MAPQ, 0-60)
- **Y-axis**: Frequency (count)
- **Purpose**: Assess alignment uniqueness and confidence

**Interpretation**:
- **Peak at 60**: Most alignments are unique (ideal)
- **Peak at 0-10**: Many ambiguous alignments (concern)
- **Bimodal (0 and 60)**: Mix of unique and multi-mapping contigs

**Visual Example:**
```
Frequency
    |                       â•­â”€â”€â•®
200 |                       â”‚  â”‚
150 |                       â”‚  â”‚
100 |                       â”‚  â”‚
 50 | â•­â”€â•®                   â”‚  â”‚
  0 |â”€â”‚â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”‚â”€â”€ MAPQ
     0  10  20  30  40  50  60
```

#### `MySample_sites_per_chr.png` ðŸ“Š
- **Format**: PNG image (300 DPI)
- **Dimensions**: 12" Ã— 6"
- **Description**: Bar chart showing number of integration sites per chromosome
- **X-axis**: Chromosome names
- **Y-axis**: Number of integration sites
- **Purpose**: Identify chromosomes with high integration site density

**Interpretation**:
- **Uniform distribution**: Sites spread evenly across genome
- **Hotspot chromosomes**: Specific chromosomes with many sites (may indicate integration preference)
- **Zero sites**: Chromosomes without detected integration events

**Visual Example:**
```
Sites
    |
 50 |     â•‘     â•‘           â•‘
 40 |     â•‘     â•‘     â•‘     â•‘
 30 |     â•‘     â•‘     â•‘     â•‘     â•‘
 20 | â•‘   â•‘     â•‘     â•‘     â•‘     â•‘
 10 | â•‘   â•‘     â•‘     â•‘     â•‘     â•‘     â•‘
  0 |â”€â•‘â”€â”€â”€â•‘â”€â”€â”€â”€â”€â•‘â”€â”€â”€â”€â”€â•‘â”€â”€â”€â”€â”€â•‘â”€â”€â”€â”€â”€â•‘â”€â”€â”€â”€â”€â•‘â”€â”€
    chr1 chr2 chr3 chr4 chr5 chr6 chr7 ...
```

#### `versions.yml`
```yaml
"QC_PLOTS":
    python: "3.11"
    matplotlib: "3.8.0"
```

---

## ðŸ“ˆ Expected File Sizes

For a typical mammalian genome (3 Gb) with HiFi data:

| File | Approximate Size | Notes |
|------|------------------|-------|
| `MySample.asm.bp.p_ctg.gfa` | 100-300 MB | Text format, compressible |
| `MySample_purged.fa` | 800 MB - 1 GB | FASTA, ~3 Gb uncompressed |
| `MySample_haplotigs.fa` | 200-500 MB | Removed sequences |
| `MySample_dups.bed` | 1-10 MB | Text format |
| `PB.base.cov` | 200-500 MB | Large, can be deleted after completion |
| `cutoffs` | <1 KB | Small text file |
| `MySample_summary.txt` | <1 KB | Small text file |
| `MySample.paf` | 10-50 MB | Text format, compressible |
| `*.png` (3 plots) | 100-500 KB each | High-res images |
| Total | **~2-3 GB** | Varies with genome size |

---

## ðŸ” Key Output Files for Downstream Analysis

### Primary Outputs (Keep These!)
1. â­ **`MySample_purged.fa`**: Your high-quality assembly â†’ use for annotations, comparisons
2. â­ **`MySample.paf`**: Alignment results â†’ use for synteny analysis, integration site mapping
3. â­ **All PNG plots**: QC visualizations â†’ include in reports/publications

### Secondary Outputs (Archive or Discard)
- `MySample.asm.bp.p_ctg.gfa`: Intermediate, can recreate from raw data
- `MySample_haplotigs.fa`: Keep if studying haplotypes, otherwise discard
- `PB.base.cov`: Large file, can discard after successful run
- `cutoffs`: Small, keep for reproducibility
- `versions.yml` files: Keep for reproducibility reports

### Intermediate Files (Auto-cleaned by Nextflow)
The `work/` directory contains intermediate files that are automatically cleaned up based on your Nextflow configuration. These include:
- Temporary alignment files
- Split assembly files
- Intermediate coverage calculations

---

## ðŸ“‹ Validation Checklist

After pipeline completion, verify:

- [ ] `MySample_purged.fa` exists and is >0 bytes
- [ ] Assembly size is reasonable (~haploid genome size)
- [ ] `MySample.paf` contains alignments (file size >1 MB)
- [ ] All three PNG plots generated successfully
- [ ] Mapping quality plot shows peak at 60 (good uniqueness)
- [ ] Alignment length distribution is reasonable
- [ ] Integration sites distributed across chromosomes

---

## ðŸ”§ Downstream Analysis Examples

### 1. Count contigs in final assembly
```bash
grep -c "^>" results/purge_dups/MySample_purged.fa
```

### 2. Calculate N50 of purged assembly
```bash
seqkit stats results/purge_dups/MySample_purged.fa
```

### 3. Extract alignments for specific chromosome
```bash
awk '$6 == "chr1"' results/minimap2_align/MySample.paf > chr1_alignments.paf
```

### 4. Count high-quality alignments (MAPQ >= 60)
```bash
awk '$12 >= 60' results/minimap2_align/MySample.paf | wc -l
```

### 5. Visualize assembly graph (requires Bandage)
```bash
Bandage load results/hifiasm/MySample.asm.bp.p_ctg.gfa
```

---

## ðŸ“Š Expected Results for Quality Data

**Good Assembly:**
- Purged assembly: 2.8-3.2 Gb (for human)
- Contig N50: >1 Mb
- Haplotig percentage: 20-40%
- MAPQ peak at 60: >80% of alignments
- Alignment coverage: >95% of assembly aligns

**Problematic Assembly:**
- Purged assembly: <2.5 Gb or >3.5 Gb (for human)
- Contig N50: <100 kb
- Haplotig percentage: >60% (over-purging) or <10% (under-purging)
- MAPQ peak at 0: >50% of alignments (repetitive)
- Alignment coverage: <80% of assembly aligns

---

## ðŸŽ¯ Summary

The pipeline produces:
- **1 high-quality assembly** (purged FASTA)
- **1 alignment file** (PAF format)
- **3 QC visualizations** (PNG plots)
- **Supporting statistics** (BED, summary, versions)

All outputs are publication-ready and suitable for:
- Genome annotation
- Comparative genomics
- Integration site analysis
- Assembly quality assessment
- Manuscript figures (plots)
