/*
========================================================================================
    Integration Site Analysis Pipeline Configuration
========================================================================================
*/

// Workflow parameters
params {
    // Input/output options
    hifi_reads          = null
    reference           = null
    integration_sites   = null
    outdir              = './results'
    sample_id           = 'sample'
    
    // Hifiasm options
    hifiasm_mode        = 'hifi'
    
    // Purge_dups options
    purge_dups_cutoffs  = null  // Auto-calculate if null
    
    // Minimap2 alignment options
    minimap2_preset     = 'asm5'  // For assembly-to-reference alignment
    
    // Resource limits
    max_cpus            = 16
    max_memory          = '128.GB'
    max_time            = '240.h'
    
    // Boilerplate options
    help                = false
    version             = false
    publish_dir_mode    = 'copy'
}

// Global default parameters
manifest {
    name            = 'integration-site-analysis'
    author          = 'Seqera AI'
    homePage        = ''
    description     = 'Genome assembly and integration site detection pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=25.04.0'
    version         = '1.0.0'
}

// Executor configuration
executor {
    name = 'local'
    cpus = params.max_cpus
    memory = params.max_memory
}

// Process configuration
process {
    
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]
    
    // Default resources
    cpus   = 1
    memory = 6.GB
    time   = 4.h
    
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'
    
    // Process-specific resources
    withLabel: process_single {
        cpus   = 1
        memory = 6.GB
        time   = 4.h
    }
    withLabel: process_low {
        cpus   = 2
        memory = 12.GB
        time   = 4.h
    }
    withLabel: process_medium {
        cpus   = 6
        memory = 36.GB
        time   = 8.h
    }
    withLabel: process_high {
        cpus   = 12
        memory = 72.GB
        time   = 16.h
    }
    withLabel: process_long {
        time   = 20.h
    }
    
    // Process-specific arguments
    withName: 'HIFIASM' {
        ext.args = '--primary'
    }
    withName: 'MINIMAP2_ALIGN' {
        ext.args = '-x asm5'
    }
}

// Profiles
profiles {
    
    debug {
        dumpHashes             = true
        process.beforeScript   = 'echo $HOSTNAME'
        cleanup                = false
        nextflow.enable.configProcessNamesValidation = true
    }
    
    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
    }
    
    docker {
        docker.enabled         = true
        conda.enabled          = false
        singularity.enabled    = false
        docker.runOptions      = '-u $(id -u):$(id -g)'
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        conda.enabled          = false
        docker.enabled         = false
    }
    
    test {
        params.max_cpus        = 2
        params.max_memory      = '6.GB'
        params.max_time        = '6.h'
    }
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']
